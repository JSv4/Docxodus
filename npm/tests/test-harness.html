<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Docxodus WASM Test Harness</title>
</head>
<body>
    <h1>Docxodus WASM Test Harness</h1>
    <div id="status">Loading...</div>
    <pre id="output"></pre>

    <script type="module">
        import { dotnet } from './_framework/dotnet.js';

        const { getAssemblyExports, getConfig } = await dotnet
            .withDiagnosticTracing(false)
            .create();

        const config = getConfig();
        const exports = await getAssemblyExports(config.mainAssemblyName);

        // Expose Docxodus APIs to window for testing
        window.Docxodus = {
            DocumentConverter: exports.DocxodusWasm.DocumentConverter,
            DocumentComparer: exports.DocxodusWasm.DocumentComparer
        };

        // Test helper functions
        window.DocxodusTests = {
            // Convert DOCX to HTML
            convertToHtml: function(bytes) {
                try {
                    const result = window.Docxodus.DocumentConverter.ConvertDocxToHtml(bytes);
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    return { html: result };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            // Compare two documents
            compareDocuments: function(originalBytes, modifiedBytes, authorName = 'Test') {
                try {
                    const result = window.Docxodus.DocumentComparer.CompareDocuments(
                        originalBytes, modifiedBytes, authorName
                    );
                    if (result.length === 0) {
                        return { error: { message: 'Comparison returned empty result' } };
                    }
                    return { docxBytes: result };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            // Compare and get HTML (with tracked changes visible by default)
            compareToHtml: function(originalBytes, modifiedBytes, authorName = 'Test') {
                try {
                    const result = window.Docxodus.DocumentComparer.CompareDocumentsToHtml(
                        originalBytes, modifiedBytes, authorName
                    );
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    return { html: result };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            // Compare and get HTML with options
            compareToHtmlWithOptions: function(originalBytes, modifiedBytes, authorName = 'Test', renderTrackedChanges = true) {
                try {
                    const result = window.Docxodus.DocumentComparer.CompareDocumentsToHtmlWithOptions(
                        originalBytes, modifiedBytes, authorName, renderTrackedChanges
                    );
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    return { html: result };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            // Get revisions from compared document
            getRevisions: function(docxBytes) {
                try {
                    const result = window.Docxodus.DocumentComparer.GetRevisionsJson(docxBytes);
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    const parsed = JSON.parse(result);
                    return { revisions: parsed.Revisions || [] };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            // Get version info
            getVersion: function() {
                return JSON.parse(window.Docxodus.DocumentConverter.GetVersion());
            },

            // Convert DOCX to HTML with pagination
            convertToHtmlWithPagination: function(bytes, paginationMode = 1, paginationScale = 1.0) {
                try {
                    const result = window.Docxodus.DocumentConverter.ConvertDocxToHtmlWithPagination(
                        bytes,
                        'Document',      // pageTitle
                        'docx-',         // cssPrefix
                        true,            // fabricateClasses
                        '',              // additionalCss
                        -1,              // commentRenderMode (disabled)
                        'comment-',      // commentCssClassPrefix
                        paginationMode,  // 0=None, 1=Paginated
                        paginationScale, // scale factor
                        'page-'          // paginationCssClassPrefix
                    );
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    return { html: result };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            // Convert DOCX to HTML with annotations
            convertToHtmlWithAnnotations: function(bytes, renderAnnotations = true, annotationLabelMode = 0) {
                try {
                    const result = window.Docxodus.DocumentConverter.ConvertDocxToHtmlFull(
                        bytes,
                        'Document',      // pageTitle
                        'docx-',         // cssPrefix
                        true,            // fabricateClasses
                        '',              // additionalCss
                        -1,              // commentRenderMode (disabled)
                        'comment-',      // commentCssClassPrefix
                        0,               // paginationMode (None)
                        1.0,             // paginationScale
                        'page-',         // paginationCssClassPrefix
                        renderAnnotations,      // renderAnnotations
                        annotationLabelMode,    // annotationLabelMode: 0=Above, 1=Inline, 2=Tooltip, 3=None
                        'annot-'                // annotationCssClassPrefix
                    );
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    return { html: result };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            // Get annotations from a document
            getAnnotations: function(bytes) {
                try {
                    const result = window.Docxodus.DocumentConverter.GetAnnotations(bytes);
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    const parsed = JSON.parse(result);
                    return { annotations: parsed.Annotations || [] };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            // Add an annotation to a document
            addAnnotation: function(bytes, request) {
                try {
                    const requestJson = JSON.stringify(request);
                    const result = window.Docxodus.DocumentConverter.AddAnnotation(bytes, requestJson);
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    const parsed = JSON.parse(result);
                    // Decode base64 document bytes
                    let documentBytes = null;
                    if (parsed.DocumentBytes) {
                        const binaryString = atob(parsed.DocumentBytes);
                        documentBytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) {
                            documentBytes[i] = binaryString.charCodeAt(i);
                        }
                    }
                    return {
                        success: parsed.Success,
                        documentBytes: documentBytes,
                        annotation: parsed.Annotation
                    };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            // Remove an annotation from a document
            removeAnnotation: function(bytes, annotationId) {
                try {
                    const result = window.Docxodus.DocumentConverter.RemoveAnnotation(bytes, annotationId);
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    const parsed = JSON.parse(result);
                    // Decode base64 document bytes
                    let documentBytes = null;
                    if (parsed.DocumentBytes) {
                        const binaryString = atob(parsed.DocumentBytes);
                        documentBytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) {
                            documentBytes[i] = binaryString.charCodeAt(i);
                        }
                    }
                    return {
                        success: parsed.Success,
                        documentBytes: documentBytes
                    };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            // Check if a document has annotations
            hasAnnotations: function(bytes) {
                try {
                    const result = window.Docxodus.DocumentConverter.HasAnnotations(bytes);
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    const parsed = JSON.parse(result);
                    return { hasAnnotations: parsed.HasAnnotations };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            // Get document structure for element-based annotation targeting
            getDocumentStructure: function(bytes) {
                try {
                    const result = window.Docxodus.DocumentConverter.GetDocumentStructure(bytes);
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    const parsed = JSON.parse(result);
                    return {
                        root: parsed.Root,
                        elementsById: parsed.ElementsById,
                        tableColumns: parsed.TableColumns
                    };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            // Get document metadata for lazy loading (Phase 3)
            getDocumentMetadata: async function(bytes) {
                try {
                    // Yield to browser before WASM work (matching main API behavior)
                    await new Promise(resolve => {
                        requestAnimationFrame(() => {
                            requestAnimationFrame(() => resolve(undefined));
                        });
                    });

                    const result = window.Docxodus.DocumentConverter.GetDocumentMetadata(bytes);
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    const parsed = JSON.parse(result);

                    // Convert from PascalCase to camelCase for consistency
                    const convertSection = (s) => ({
                        sectionIndex: s.SectionIndex ?? s.sectionIndex,
                        pageWidthPt: s.PageWidthPt ?? s.pageWidthPt,
                        pageHeightPt: s.PageHeightPt ?? s.pageHeightPt,
                        marginTopPt: s.MarginTopPt ?? s.marginTopPt,
                        marginRightPt: s.MarginRightPt ?? s.marginRightPt,
                        marginBottomPt: s.MarginBottomPt ?? s.marginBottomPt,
                        marginLeftPt: s.MarginLeftPt ?? s.marginLeftPt,
                        contentWidthPt: s.ContentWidthPt ?? s.contentWidthPt,
                        contentHeightPt: s.ContentHeightPt ?? s.contentHeightPt,
                        headerPt: s.HeaderPt ?? s.headerPt,
                        footerPt: s.FooterPt ?? s.footerPt,
                        paragraphCount: s.ParagraphCount ?? s.paragraphCount,
                        tableCount: s.TableCount ?? s.tableCount,
                        hasHeader: s.HasHeader ?? s.hasHeader,
                        hasFooter: s.HasFooter ?? s.hasFooter,
                        hasFirstPageHeader: s.HasFirstPageHeader ?? s.hasFirstPageHeader,
                        hasFirstPageFooter: s.HasFirstPageFooter ?? s.hasFirstPageFooter,
                        hasEvenPageHeader: s.HasEvenPageHeader ?? s.hasEvenPageHeader,
                        hasEvenPageFooter: s.HasEvenPageFooter ?? s.hasEvenPageFooter,
                        startParagraphIndex: s.StartParagraphIndex ?? s.startParagraphIndex,
                        endParagraphIndex: s.EndParagraphIndex ?? s.endParagraphIndex,
                        startTableIndex: s.StartTableIndex ?? s.startTableIndex,
                        endTableIndex: s.EndTableIndex ?? s.endTableIndex,
                    });

                    return {
                        sections: (parsed.Sections || parsed.sections || []).map(convertSection),
                        totalParagraphs: parsed.TotalParagraphs ?? parsed.totalParagraphs,
                        totalTables: parsed.TotalTables ?? parsed.totalTables,
                        hasFootnotes: parsed.HasFootnotes ?? parsed.hasFootnotes,
                        hasEndnotes: parsed.HasEndnotes ?? parsed.hasEndnotes,
                        hasTrackedChanges: parsed.HasTrackedChanges ?? parsed.hasTrackedChanges,
                        hasComments: parsed.HasComments ?? parsed.hasComments,
                        estimatedPageCount: parsed.EstimatedPageCount ?? parsed.estimatedPageCount,
                    };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            // Convert DOCX to HTML with pagination AND tracked changes
            convertToHtmlWithPaginationAndTrackedChanges: function(bytes, paginationMode = 1, paginationScale = 1.0, renderTrackedChanges = true) {
                try {
                    const result = window.Docxodus.DocumentConverter.ConvertDocxToHtmlComplete(
                        bytes,
                        'Document',           // pageTitle
                        'docx-',              // cssPrefix
                        true,                 // fabricateClasses
                        '',                   // additionalCss
                        -1,                   // commentRenderMode (disabled)
                        'comment-',           // commentCssClassPrefix
                        paginationMode,       // 0=None, 1=Paginated
                        paginationScale,      // scale factor
                        'page-',              // paginationCssClassPrefix
                        false,                // renderAnnotations
                        0,                    // annotationLabelMode
                        'annot-',             // annotationCssClassPrefix
                        true,                 // renderFootnotesAndEndnotes
                        true,                 // renderHeadersAndFooters
                        renderTrackedChanges, // renderTrackedChanges
                        true,                 // showDeletedContent
                        true                  // renderMoveOperations
                    );
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    return { html: result };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            // Add annotation with flexible targeting
            addAnnotationWithTarget: function(bytes, request) {
                try {
                    const requestJson = JSON.stringify(request);
                    const result = window.Docxodus.DocumentConverter.AddAnnotationWithTarget(bytes, requestJson);
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    const parsed = JSON.parse(result);
                    // Decode base64 document bytes
                    let documentBytes = null;
                    if (parsed.DocumentBytes) {
                        const binaryString = atob(parsed.DocumentBytes);
                        documentBytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) {
                            documentBytes[i] = binaryString.charCodeAt(i);
                        }
                    }
                    return {
                        success: documentBytes != null,  // Success if we have document bytes
                        documentBytes: documentBytes,
                        annotation: parsed.Annotation
                    };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            // ===== Profiling API (for performance analysis) =====

            /**
             * Profile document conversion with timing breakdown.
             * Returns HTML plus detailed timing for each conversion phase.
             */
            profileConversion: function(bytes) {
                try {
                    const result = window.Docxodus.DocumentConverter.ConvertDocxToHtmlProfiled(bytes);
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    return JSON.parse(result);
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            /**
             * Profile document conversion with more granular phase timing.
             */
            profileConversionDetailed: function(bytes) {
                try {
                    const result = window.Docxodus.DocumentConverter.ProfileConversionDetailed(bytes);
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    return JSON.parse(result);
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            // ===== External Annotation API (Issue #57) =====

            /**
             * Compute SHA256 hash of document for integrity validation.
             */
            computeDocumentHash: function(bytes) {
                try {
                    const result = window.Docxodus.DocumentConverter.ComputeDocumentHash(bytes);
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    const parsed = JSON.parse(result);
                    return { hash: parsed.Hash || parsed.hash };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            /**
             * Create external annotation set from document.
             */
            createExternalAnnotationSet: function(bytes, documentId) {
                try {
                    const result = window.Docxodus.DocumentConverter.CreateExternalAnnotationSet(bytes, documentId);
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    return { annotationSet: JSON.parse(result) };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            /**
             * Validate external annotations against document.
             */
            validateExternalAnnotations: function(bytes, annotationSet) {
                try {
                    const annotationSetJson = JSON.stringify(annotationSet);
                    const result = window.Docxodus.DocumentConverter.ValidateExternalAnnotations(bytes, annotationSetJson);
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    const parsed = JSON.parse(result);
                    return {
                        isValid: parsed.IsValid ?? parsed.isValid,
                        hashMismatch: parsed.HashMismatch ?? parsed.hashMismatch,
                        issues: parsed.Issues || parsed.issues || []
                    };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            /**
             * Convert DOCX to HTML with external annotations projected.
             */
            convertToHtmlWithExternalAnnotations: function(bytes, annotationSet, labelMode = 1) {
                try {
                    const annotationSetJson = JSON.stringify(annotationSet);
                    const result = window.Docxodus.DocumentConverter.ConvertDocxToHtmlWithExternalAnnotations(
                        bytes,
                        annotationSetJson,
                        'Document',       // pageTitle
                        'docx-',          // cssPrefix
                        true,             // fabricateClasses
                        '',               // additionalCss
                        'ext-annot-',     // extAnnotCssClassPrefix
                        labelMode         // 0=Above, 1=Inline, 2=Tooltip, 3=None
                    );
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    const parsed = JSON.parse(result);
                    return { html: parsed.Html || parsed.html };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            /**
             * Search for text occurrences in document.
             */
            searchTextOffsets: function(bytes, searchText, maxResults = 100) {
                try {
                    const result = window.Docxodus.DocumentConverter.SearchTextOffsets(bytes, searchText, maxResults);
                    if (result.startsWith('{') && result.includes('"Error"')) {
                        return { error: JSON.parse(result) };
                    }
                    const parsed = JSON.parse(result);
                    return {
                        results: (parsed.Results || parsed.results || []).map(r => ({
                            id: r.Id ?? r.id,
                            start: r.Start ?? r.start,
                            end: r.End ?? r.end,
                            text: r.Text ?? r.text
                        }))
                    };
                } catch (e) {
                    return { error: { message: e.message } };
                }
            },

            /**
             * Client-side helper: Create annotation from offsets.
             */
            createAnnotationFromOffsets: function(id, labelId, documentText, startOffset, endOffset) {
                if (startOffset < 0 || endOffset < startOffset || endOffset > documentText.length) {
                    return { error: { message: 'Invalid offsets' } };
                }
                const rawText = documentText.substring(startOffset, endOffset);
                return {
                    annotation: {
                        id: id,
                        annotationLabel: labelId,
                        rawText: rawText,
                        page: 0,
                        annotationJson: { id: id, start: startOffset, end: endOffset, text: rawText },
                        annotationType: 'text',
                        structural: false
                    }
                };
            },

            /**
             * Client-side helper: Find all occurrences of text.
             */
            findTextOccurrences: function(documentText, searchText, maxResults = 100) {
                const results = [];
                let index = 0;
                while (results.length < maxResults) {
                    index = documentText.indexOf(searchText, index);
                    if (index < 0) break;
                    results.push({ start: index, end: index + searchText.length });
                    index += 1;
                }
                return results;
            },

            /**
             * Client-side helper: Create annotation by searching for text.
             */
            createAnnotationFromSearch: function(id, labelId, documentText, searchText, occurrence = 1) {
                const offsets = this.findTextOccurrences(documentText, searchText);
                if (occurrence > offsets.length) {
                    return { annotation: null };
                }
                const { start, end } = offsets[occurrence - 1];
                return this.createAnnotationFromOffsets(id, labelId, documentText, start, end);
            }
        };

        document.getElementById('status').textContent = 'Ready';
        window.DocxodusReady = true;
        console.log('Docxodus WASM Test Harness Ready');
        console.log('Version:', window.DocxodusTests.getVersion());
    </script>
</body>
</html>
